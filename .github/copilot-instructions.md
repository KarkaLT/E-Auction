# Copilot Instructions — E‑Auction (Laravel + Inertia + React)

Summary

- Laravel 12 backend (PHP 8.2+); Inertia + React (Vite + TypeScript) frontend.
- Responsibilities:
  - Backend: business logic, persistence, auth, queueing, mail, CLI commands, server routes.
  - Frontend: Inertia pages + React components, client-side logic, typed route helpers from wayfinder.

Quick highlights for AI agents

- Run commands inside the Docker development containers (prefer `workspace` or `php-fpm`). Examples:
  - `docker compose -f compose.dev.yaml exec workspace bash` (interactive shell)
  - `docker compose -f compose.dev.yaml exec workspace composer setup` (initial setup)
  - `docker compose -f compose.dev.yaml exec workspace php artisan wayfinder:generate` (regenerate TypeScript route/actions files)
  - `docker compose -f compose.dev.yaml exec workspace php artisan storage:link` (ensure public URLs for uploaded files)

Important developer workflows

- Start dev environment: prefer Docker `compose.dev.yaml` (dev services: `workspace`, `php-fpm`, `web`, `mysql`, `redis`, `mailpit`).
  - Start: `docker compose -f compose.dev.yaml up -d --build`
  - Stop: `docker compose -f compose.dev.yaml down`
- Composer scripts (for the workspace container):
  - `composer setup` — installs dependencies, creates `.env`, runs migrations and builds frontend assets
  - `composer dev` — starts PHP server, queue listener, pail logs and Vite via `concurrently` (for local non-Docker flow)
  - `composer run dev:ssr` — SSR flow (server + queue + pail + inertia:ssr)
- Frontend build / dev: use `npm run dev` or `npm run build` inside container; `vite` has `wayfinder` plugin enabled for generating typed route helpers during build.
- Route / Types generation: run `php artisan wayfinder:generate` when backend route signatures change; the files are generated in `resources/js/routes` and `resources/js/actions` (or configured path). If you modify controller method signatures or add routes, regenerate via this command.

Repo-specific conventions / patterns

- Actions (single-responsibility classes): place new business logic in `app/Actions/<Feature>` rather than controllers. Example: `app/Actions/AuctionItems/StoreAuctionItemPhotos.php` which:
  - converts uploaded images to WebP using ext-gd functions,
  - stores them with `Storage::disk('public')`,
  - uses `DB::transaction()` and cleans up partially stored files on failure.
- Controllers are thin; use `authorize()` or `policy` checks (e.g., `app/Policies/AuctionItemPolicy.php`). Use `DB::transaction()` for multi-step state changes.
- Role checks and middlewares: `EnsureSeller`, `EnsureBuyer`, `EnsureUserIsAdmin`, and `EnsureUserNotBlocked` live in `app/Http/Middleware`. Prefer middleware usage for access gating and make sure to check `User::isSeller()` / `isBuyer()` / `isAdmin()` if needed.
- Route registration order matters: protected (resource) routes are registered BEFORE public `show` routes to prevent path collisions (see `routes/web.php`).

Frontend specifics

- Routes and typed actions: `resources/js/routes/*` and `resources/js/actions/*` are generated by Wayfinder. Use the exported helpers instead of hard-coded strings. E.g. `auctionItems.create().url`.
- Shared props (Inertia): `usePage<SharedData>().props` reads shared data; `resources/js/types/index.d.ts` defines `SharedData` and models like `AuctionItem`.
- UI components and patterns: `resources/js/components/ui/*` are shared; pages in `resources/js/pages/*` and layouts in `resources/js/layouts/*` (AppLayout is the main wrapper).
- For AJAX-only endpoints (not Inertia), use `fetch()` with headers `Accept: 'application/json'` and, when needed, add `X-Inertia: 'false'` (e.g., `settings/sidebar-state` uses `X-Inertia: 'false'` to avoid Inertia handling the response). For in-page actions, prefer typed actions from `resources/js/actions/*`.

Important API & UX patterns to follow

- File uploads: validate in controllers (e.g., `image|mimes:jpeg,jpg,png,webp,avif|max:5120`) and convert in Actions. Ensure `ext-gd` with WebP support is available in the dev image; image processing will fail without it.
- Auctions / bidding: `AuctionItemController@placeBid` is a JSON POST endpoint (returning updated auction data). The frontend uses `fetch()` and `router.reload()` to re-load Inertia page data after success.
- Mutating operations should:
  - use `DB::transaction()` to ensure consistency,
  - `refresh()` models inside transactions if needed to avoid stale reads,
  - catch and `report($exception)` before returning an appropriate HTTP error response.
- Background processes / queue: `php artisan queue:listen` should run in dev to process jobs and queue-based flows (used with `composer dev`).
  - `php artisan pail` requires the `pcntl` extension; the `workspace`/`php-fpm` images include this in dev targets.

- CI / Formatting / Husky hooks
- CI runs `npm run build`.
- Formatting & linting: `vendor/bin/pint` (PHP) + `npm run lint` / `npm run format` (frontend). The repository uses Husky + lint-staged hooks.

Common commands (copy-paste) — run inside `workspace` container

```fish
docker compose -f compose.dev.yaml up -d --build
docker compose -f compose.dev.yaml exec workspace bash # get a shell
docker compose -f compose.dev.yaml exec workspace composer setup
docker compose -f compose.dev.yaml exec workspace php artisan migrate --force
docker compose -f compose.dev.yaml exec workspace php artisan wayfinder:generate
docker compose -f compose.dev.yaml exec workspace php artisan storage:link
docker compose -f compose.dev.yaml exec workspace npm run dev
```

Integration points & external dependencies

- Databases: MySQL (container `mysql`), Redis (`redis`) for caching/queue drivers.
- Mail: `mailpit` container for SMTP in dev.
- Wayfinder (routes + actions generation) powers frontend type-safety — run `php artisan wayfinder:generate` after route/controller changes.

What AI agents should do when adding features

- Add new business logic to `app/Actions/*`.
- Keep controllers thin: validate request, authorize, dispatch Actions, return Inertia or JSON as needed.
- If adding new routes that also get entered by the frontend, regenerate Wayfinder output to keep typed route definitions in sync.
- If adding public resource routes with `Route::resource`, register protected (create/edit/store/update) resource routes BEFORE the public `show` route to avoid a path collision.

Examples (copy-paste safe)

- Using typed route helper (frontend):
  - `import auctionItems from '@/routes/auction-items'
  - `<Link href={auctionItems.create().url}>Create</Link>`
- AJAX-only endpoint call (frontend):
  - `await fetch('/settings/sidebar-state', { method: 'POST', headers: { 'Content-Type': 'application/json', Accept: 'application/json', 'X-Inertia': 'false', }, body: JSON.stringify({ sidebar_open: isOpen }) })`
- Using an Action in a controller (backend):
  - `DB::transaction(fn() => { $auction = AuctionItem::create($validated); $this->storeAuctionItemPhotos->handle($auction, $photos); })`
